\chapter{Modelado de configuración automática de infraestructuras distribuidas}
\label{cap:modelado}

[Revisar]\\

La extensión a la herramienta de configuración Puppet se ha hecho mediante el uso de tipos y proveedores personalizados. Mediante la definición de un nuevo tipo estamos añadiendo un nuevo recurso que Puppet puede administrar; pero para que Puppet sepa cómo administrar ese nuevo recurso debemos proporcionar un proveedor en el que se le indique lo que tiene que hacer.


\section{Modelado de recursos y configuración automática en Puppet}

Puppet usa un lenguaje declarativo para modelar los distintos elementos de configuración, que en la terminología de Puppet se llaman recursos. Mediante el uso de este lenguaje se indica en qué estado se quiere mantener el recurso y será tarea de Puppet el encargarse de que así sea. Cada recurso está compuesto de un tipo (el tipo de recurso que estamos gestionando), un título (el nombre del recurso) y una serie de atributos (los valores que especifican el estado del recurso). Por ejemplo, para modelar un recurso de tipo fichero podríamos usar algo similar a:

\begin{lstlisting}
file {'testfile':
  path    => '/tmp/testfile',
  ensure  => present,
  mode    => 0640,
  content => "I'm a test file.",
}
\end{lstlisting}

La agrupación de uno o más recursos en un fichero de texto da lugar a un manifiesto. En general, un manifiesto contiene la información necesaria para realizar la configuración de un nodo. Cuando a Puppet se le da la orden de aplicar un manifiesto los pasos que hace son:
\begin{itemize}
\item Interpretar y compilar la configuración.
\item Comunicar la configuración compilada al nodo.
\item Aplicar la configuración en el nodo.
\item Enviar un informe con los resultados.
\end{itemize}


\section{Modelado de recursos distribuidos: el recurso \emph{cloud}}

El modelado de un recurso distribuido plantea ciertos desafíos al modelo anterior: se puede pensar que para modelar un recurso distribuido basta con que Puppet envíe a cada nodo la configuración necesaria para garantizar el comportamiento deseado, pero, ¿qué pasa cuando ese nodo falla? Si no hacemos nada, el recurso dejará de mantenerse en el estado deseado. Por lo tanto, a la hora de administrar un recurso distribuido hay que asegurarse de que los nodos están operativos y cumpliendo con su función. Asimismo, un recurso distribuido puede presentar elementos comunes para todos los nodos del sistema, a diferencia de un recurso clásico de Puppet en el que el nodo posee o no ese recurso, pero no hay elementos comunes.\\

Se puede hacer una analogía con la programación orientada a objetos en la que el recurso distribuido sería una metaclase que proporcionaría los atributos y métodos comunes a todo recurso distribuido tales como un nombre o una administración básica. La instanciación de ese recurso en un recurso distribuido de tipo AppScale, Torque, web u otros sería similar a la instanciación de una clase a partir de la metaclase. De igual manera, el recurso distribuido instanciado podría añadir nuevos atributos y métodos y modificar el comportamiento de los métodos de la metaclase, ya que no tienen por qué iniciarse de igual manera el recurso AppScale y el recurso Torque.\\

%%% Revisar
En Puppet cualquier recurso que se define se presupone definido dentro de un ámbito local. Para poder diferenciar los recursos distribuidos de los locales, se ha añadido (al final no) a la gramática de Puppet una palabra reservada. Ya que los ejemplos caen dentro de la categoría de \emph{cloud} la palabra que se ha escogido ha sido \texttt{cloudres}.\\

Para modelar un recurso \emph{cloud}, se han considerado como fundamentales los siguientes parámetros:

\begin{itemize}
\item Nombre: Para identificar al \emph{cloud} de manera única.
\item Fichero de direcciones IP: Para describir qué dirección IP está asociada a cada nodo del \emph{cloud}.
\item Fichero de imágenes de disco: Para asignar a cada nodo la correspondiente imagen de disco duro.
\item Fichero de dominio: Para definir una máquina virtual especificando sus características \emph{hardware}.
\item Conjunto de máquinas físicas: Para indicar qué máquinas físicas pueden ejecutar las máquinas virtuales definidas.
\end{itemize}

%%% Revisar: cloudres, y las rutas de los ficheros
Para modelar un recurso \emph{cloud} de tipo Torque podríamos usar algo similar a:

\begin{lstlisting}
cloudres torque {'torque-cloud':
   ip_file  => "/etc/puppet/modules/cloud/files/jobs-ip.yaml",
   img_file => "/etc/puppet/modules/cloud/files/jobs-img.yaml",
   domain   => "/etc/puppet/modules/cloud/files/mycloud-template.xml",
   pool     => ["155.210.155.70"],
   ensure   => running,
}
\end{lstlisting}


\section{Diseño del proveedor de recursos distribuidos}

Puppet puede ser extendido para incluir la definición de nuevos recursos. Para ello hay que proporcinarle, como mínimo, dos ficheros: uno en el que se define el recurso y otro en el que se define cómo gestionar ese recurso. Al fichero en el que se define el recurso se le llama tipo y al fichero en el que se define cómo gestionarlo se le llama proveedor. Es decir, el tipo se encarga del ``qué'' y el proveedor se encarga del ``cómo''.\\

En un recurso cloud la definición en el fichero tipo contendría los parámetros propios de ese tipo de cloud. En el ejemplo anterior éstos serían: \texttt{ip\_file}, \texttt{img\_file}, \texttt{domain} y \texttt{pool} (el parámetro \texttt{ensure} es común a todo recurso puppet y se define automáticamente). Una vez modelado el recurso \emph{cloud}, queda como tarea proporcionar un proveedor que se encargue de llevar el \emph{cloud} al estado que se le indique desde el manifiesto Puppet. Un \emph{cloud} podrá estar en dos estados: funcionando o parado. Si tiene que estar funcionando, el proveedor se encargará de todos los pasos necesarios para llevar al \emph{cloud} a ese estado, que a grandes rasgos son:

\begin{itemize}
\item Comprobación de la existencia del \emph{cloud}: si existe se realizarán tareas de mantenimiento, si no existe se creará.
\item Comprobación del estado del conjunto de máquinas físicas.
\item Obtención de las direcciones IP de los nodos y los roles que les han sido asignados.
\item Comprobación del estado de las máquinas virtuales: si están funcionando se monitorizan, mientras que si no están funcionando hay que definir una nueva máquina virtual y ponerla en funcionamiento. Las funciones de monitorización incluyen el envío de un fichero mediante el cual cada nodo se autoadministre la mayor parte posible.
\item Cuando todas las máquinas virtuales estén funcionando se procede a inicializar el \emph{cloud}.
\item Operaciones de puesta en marcha particulares a cada tipo de \emph{cloud}.
\end{itemize}

De la misma manera, si decidimos que el \emph{cloud} tiene que estar parado, el proveedor se encargará de realizar los pasos necesarios para ello. Estos pasos son:

\begin{itemize}
\item Comprobación de la existencia del \emph{cloud}: si existe se procederá a su parada.
\item Operaciones de parada particulares a cada tipo de \emph{cloud}.
\item Apagado y borrado de las definiciones de las máquinas virtuales creadas explícitamente para este \emph{cloud}.
\item Parada de las funciones de automantenimiento de los nodos.
\item Eliminación de los ficheros internos de gestión del \emph{cloud}.
\end{itemize}

Una parte muy importante del proveedor es el parámetro \texttt{ip\_file}. En este fichero se define una asociación entre la dirección IP del nodo y el rol que cumplirá dentro del \emph{cloud}. Siguiendo con el ejemplo del recurso \emph{cloud} de tipo Torque, el fichero de roles en el que se especifica quién es el nodo \emph{head} y la lista de nodos \emph{compute} sería similar a este:

\begin{yamlcode}
--- 
:head: 155.210.155.73
:compute:
- 155.210.155.177
\end{yamlcode}

